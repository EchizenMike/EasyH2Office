{extend name="../../base/view/common/base" /}
<!-- 主体 -->
{block name="body"}
<form class="layui-form p-4">
	<h3 class="pb-3">新增合同</h3>
    <table class="layui-table layui-table-form">
		{gt name="$pid" value="0"}
		 <tr>
			<td class="layui-td-gray">母合同名称</td>
			<td colspan="5">{$p_contract.name}<input type="hidden" name="pid" value="{$pid}"></td>
		  </tr>
		{/gt}
      <tr>
        <td class="layui-td-gray">合同名称<font>*</font></td>
        <td colspan="3"><input type="text" name="name" lay-verify="required" lay-reqText="请输入合同名称" autocomplete="off" placeholder="请输入合同名称" class="layui-input"></td>
		<td class="layui-td-gray">合同性质</td>
        <td>
			<input type="hidden" name="type" value="{$type}">
			{eq name="$type" value="1" }普通合同{/eq}
            {eq name="$type" value="2" }框架合同{/eq}
            {eq name="$type" value="3" }补充协议{/eq}
            {eq name="$type" value="4" }其他合同{/eq}
        </td>
      </tr>
      <tr>
        <td class="layui-td-gray">签约主体<span style="font-size:12px;">(乙方)</span><font>*</font></td>
        <td>
          <select name="subject_id" lay-verify="required" lay-reqText="请选择签约主体公司">
            <option value="">请选择签约主体公司</option>
            {volist name=":contract_subject()" id="v"}
            <option value="{$v.id}">{$v.title}</option>
            {/volist}
          </select>
        </td>
        <td class="layui-td-gray">合同编号<font>*</font></td>
        <td>
          <input type="text" name="code" value="{$codeno}" autocomplete="off" {notempty name="$codeno"}readonly{/notempty} lay-verify="required" lay-reqText="请输入合同编号" placeholder="请输入合同编号" class="layui-input">
        </td>
	    <td class="layui-td-gray">合同类别<font>*</font></td>
        <td>
          <select name="cate_id" lay-verify="required" lay-reqText="请选择合同类别">
            <option value="">请选择合同类别</option>
            {volist name=":contract_cate()" id="v"}
            <option value="{$v.id}">{$v.title}</option>
            {/volist}
          </select>
        </td>
      </tr>
	  <tr>
        <td class="layui-td-gray">客户名称<span style="font-size:12px;">(甲方)</span><font>*</font></td>
        <td>
			{gt name="$pid" value="0"}
			 <input type="text" name="customer" autocomplete="off" value="{$p_contract.customer}" readonly lay-verify="required" lay-reqText="请输入客户名称" placeholder="请输入客户名称" class="layui-input">
			{else/}
			 <input type="text" name="customer" autocomplete="off" {eq name="$is_customer" value="1"}readonly{/eq} lay-verify="required" lay-reqText="请输入客户名称" placeholder="请输入客户名称" class="layui-input {eq name="$is_customer" value="1"}customer-picker{/eq}">
			{/gt}
			 <input type="hidden" name="customer_id" value="0">
			
        </td>
        <td class="layui-td-gray">签约客户代表<font>*</font></td>
        <td>
          <input type="text" name="customer_name" autocomplete="off" lay-verify="required" lay-reqText="请输入客户代表姓名" placeholder="请输入客户代表姓名" class="layui-input">
        </td>
		<td class="layui-td-gray">客户联系电话<font>*</font></td>
        <td>
			<input type="text" name="customer_mobile" autocomplete="off" lay-verify="required" lay-reqText="请输入客户联系电话" placeholder="请输入客户联系电话" class="layui-input">
        </td>
      </tr>
	   <tr>
        <td class="layui-td-gray-2">客户联系地址</td>
        <td>
          <input type="text" name="customer_address" autocomplete="off" placeholder="请输入客户联系地址" class="layui-input">
        </td>
        <td class="layui-td-gray-2">合同开始日期<font>*</font></td>
        <td>
          <input type="text" name="start_time" readonly lay-verify="required" lay-reqText="请选择合同开始时间" placeholder="请选择合同开始时间" class="layui-input select-time">
        </td>
		<td class="layui-td-gray-2">合同结束日期<font>*</font></td>
        <td>
			<input type="text" name="end_time" readonly lay-verify="required" lay-reqText="请选择合同结束时间" placeholder="请选择合同结束时间" class="layui-input select-time">
        </td>
      </tr>
	  {neq name="$type" value="2"}
      <tr>
        <td class="layui-td-gray">合同金额{eq name="$type" value="1"}<font>*</font>{/eq}</td>
        <td>
           <input type="text" name="cost" value="" {eq name="$type" value="1"} lay-verify="required|number"{/eq} lay-reqText="请输入合同金额，数字" placeholder="请输入合同金额，数字" autocomplete="off" class="layui-input">
        </td>
        <td class="layui-td-gray">是否含税</td>
        <td>
          <input type="radio" name="is_tax" value="1" title="是" checked lay-filter="tax">
          <input type="radio" name="is_tax" value="0" title="否" lay-filter="tax">
        </td>
        <td class="layui-td-gray">税点(百分比)</td>
        <td>
          <input type="text" name="tax" value="" lay-verify="number" placeholder="请输入税点，数字" autocomplete="off" class="layui-input">
        </td>
      </tr>
	  {/neq}
	  <tr>
		<td colspan="6"><strong>签订信息</strong></td>
	  </tr>
	  <tr>
        <td class="layui-td-gray-2">合同签订人<font>*</font></td>
        <td>
          <input type="text" name="sign_name" autocomplete="off" readonly placeholder="请选择合同签订人" class="layui-input">
          <input type="hidden" name="sign_uid" lay-verify="required" lay-reqText="请选择合同签订人">
          <input type="hidden" name="sign_did">
        </td>
		<td class="layui-td-gray-2">合同签订时间<font>*</font></td>
        <td>
			<input type="text" name="sign_time" readonly lay-verify="required" lay-reqText="请选择合同签订日期" placeholder="请选择合同签订日期" class="layui-input select-time">
        </td>
        <td class="layui-td-gray-2">合同签订部门</td>
        <td>
          <input type="text" name="sign_department" autocomplete="off" readonly class="layui-input">
        </td>
      </tr>
	  <tr>
        <td class="layui-td-gray-2">合同制定人<font>*</font></td>
        <td>
          <input type="text" name="prepared_name" autocomplete="off" readonly placeholder="请选择合同制定人" class="layui-input picker-one">
		  <input type="hidden" name="prepared_uid" lay-verify="required" lay-reqText="请选择合同制定人">
        </td>
        <td class="layui-td-gray-2">合同保管人<font>*</font></td>
        <td>
          <input type="text" name="keeper_name" autocomplete="off" readonly placeholder="请选择合同保管人" class="layui-input picker-one">
		  <input type="hidden" name="keeper_uid" lay-verify="required" lay-reqText="请选择合同保管人">
        </td>
		<td class="layui-td-gray">合同共享人员</td>
        <td>
			<input type="text" name="share_names" autocomplete="off" readonly placeholder="请选择共享人员" class="layui-input picker-more">
			<input type="hidden" name="share_ids">
        </td>
      </tr>
	   <tr>
		<td colspan="6"><strong>备注信息</strong></td>
	  </tr>
      <tr>
        <td colspan="6">
          <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
        </td>
      </tr>
    </table>
    <div class="py-3">
	   <input type="hidden" name="scene" value="add">
      <button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="webform">立即提交</button>
      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
    </div>
</form>
{/block}
<!-- /主体 -->

<!-- 脚本 -->
{block name="script"}
<script>
	const moduleInit = ['tool','employeepicker'];
	function gouguInit() {
		var form = layui.form,tool=layui.tool,table = layui.table,laydate = layui.laydate,employeepicker = layui.employeepicker;
		//日期
		lay('.select-time').each(function () {
			laydate.render({
				elem: this,
				trigger: 'click'
			});
		});
		
		//选择合同签订人弹窗	
		$('body').on('click','[name="sign_name"]',function () {
			var ids=$('[name="sign_uid"]').val(),names=$('[name="sign_name"]').val();
			employeepicker.init({
				ids:ids,
				names:names,
				type:0,
				department_url: "/api/index/get_department_tree",
				employee_url: "/api/index/get_employee",
				callback:function(ids,names,dids,departments){
					$('[name="sign_uid"]').val(ids);
					$('[name="sign_name"]').val(names);
					$('[name="sign_did"]').val(dids);
					$('[name="sign_department"]').val(departments);
				}
			});
		});
		
		//radio选择
		form.on('radio(tax)', function(data){
			if(data.value == 0){
				$('[name="tax"]').val('0').hide();
			}else{
				$('[name="tax"]').val('').show();
			}
		});

		//监听提交
		form.on('submit(webform)', function (data) {
			if (data.field.type == 1 && data.field.cost == '') {
				layer.msg('请完善合同金额');
				return false;
			}
			if (data.field.is_tax == 1 && data.field.tax == '') {
				layer.msg('请完善税点');
				return false;
			}
			if (data.field.is_tax == 1 && data.field.cost == '') {
				layer.msg('请完善金额');
				return false;
			}
			let callback = function (e) {
				layer.msg(e.msg);
				if (e.code == 0) {
					parent.layui.tool.close(1000);
				}
			}
			tool.post("/contract/index/add", data.field, callback);
			return false;
		});
		
		//选择关联的客户	
		$('.customer-picker').on('click', function () {
			selectCustomer();
		});
		var customeTable;
		function selectCustomer() {
			layer.open({
				title: '选择客户',
				area: ['600px', '580px'],
				type: 1,
				content: '<div class="picker-table">\
					<form class="layui-form pb-2">\
						<div class="layui-input-inline" style="width:480px;">\
						<input type="text" name="keywords"  placeholder="客户名称" class="layui-input" autocomplete="off" />\
						</div>\
						<button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="search_form">提交搜索</button>\
				  	</form>\
					<div id="customerTable"></div></div>',
				success: function () {
					customeTable = table.render({
						elem: '#customerTable'
						, url: '/contract/api/get_customer'
						, page: true //开启分页
						, limit: 10
						, cols: [[
							{ type: 'radio', title: '选择' }
							, { field: 'id', width: 100, title: '编号', align: 'center' }
							, { field: 'name', title: '客户名称' }
						]]
					});
				},
				btn: ['确定'],
				yes: function () {
					var checkStatus = table.checkStatus(customeTable.config.id);
					var data = checkStatus.data;
					if (data.length > 0) {
						$('[name="customer_id"]').val(data[0].id);
						$('[name="customer"]').val(data[0].name);
						$('[name="customer_name"]').val(data[0].contact_name);
						$('[name="customer_mobile"]').val(data[0].contact_mobile);
						$('[name="customer_address"]').val(data[0].address);
						layer.closeAll();
					}
					else {
						layer.msg('请先选择客户');
						return false;
					}
				}
			})
		}
		//客户搜索提交
		form.on('submit(search_form)', function (data) {
			customeTable.reload({ where: { keywords: data.field.keywords }, page: { curr: 1 } });
			return false;
		});

	}
</script>
{/block}
<!-- /脚本 -->