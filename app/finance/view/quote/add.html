<!--{extend name="../../base/view/common/base" /}-->
<!--&lt;!&ndash; ä¸»ä½“ &ndash;&gt;-->
<!--{block name="body"}-->
<!--<form class="layui-form p-page">-->
<!--	<h3 class="pb-3">æ–°å¢æŠ¥ä»·ç”³è¯·</h3>-->
<!--	<table class="layui-table layui-table-form">-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">å¼€ç¥¨é‡‘é¢<font>*</font></td>-->
<!--			<td>-->
<!--				<input type="text" class="layui-input" name="amount" lay-verify="required|number" placeholder="è¯·è¾“å…¥å¼€ç¥¨é‡‘é¢" lay-reqText="è¯·è¾“å…¥å¼€ç¥¨é‡‘é¢" value="">	-->
<!--			</td>-->
<!--			<td class="layui-td-gray">å¼€ç¥¨ç±»å‹<font>*</font></td>-->
<!--			<td>-->
<!--			<select name="invoice_type" lay-verify="required" lay-reqText="è¯·é€‰æ‹©å¼€ç¥¨ç±»å‹">-->
<!--				<option value="">è¯·é€‰æ‹©å¼€ç¥¨ç±»å‹</option>-->
<!--				<option value="1">å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨</option>-->
<!--				<option value="2">æ™®é€šå‘ç¥¨</option>-->
<!--				<option value="3">ä¸“ä¸šå‘ç¥¨</option>-->
<!--			  </select>-->
<!--			</td>-->
<!--			<td class="layui-td-gray">å¼€ç¥¨ä¸»ä½“<font>*</font></td>-->
<!--			<td>-->
<!--				<select name="invoice_subject" lay-verify="required" lay-reqText="è¯·é€‰æ‹©å¼€ç¥¨ä¸»ä½“">-->
<!--					<option value="">è¯·é€‰æ‹©å¼€ç¥¨ä¸»ä½“</option>-->
<!--					{volist name=":get_base_data('enterprise')" id="vo"}-->
<!--					<option value="{$vo.id}">{$vo.title}</option>-->
<!--					{/volist}-->
<!--				</select>-->
<!--			</td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">æŠ¬å¤´ç±»å‹<font>*</font></td>-->
<!--			<td>-->
<!--				<input type="radio" name="types" lay-filter="type" value="1" title="ä¼ä¸š" checked>-->
<!--				<input type="radio" name="types" lay-filter="type" value="2" title="ä¸ªäºº">-->
<!--			</td>-->
<!--			<td class="layui-td-gray-2">å¼€ç¥¨æŠ¬å¤´<span class="layui-btn layui-btn-xs invoice-qiye customer-picker">é€‰æ‹©</span></td>-->
<!--			<td><input type="text" name="invoice_title" class="layui-input" value="" placeholder="è¯·è¾“å…¥å¼€ç¥¨æŠ¬å¤´" lay-verify="required"  lay-reqText="è¯·è¾“å…¥å¼€ç¥¨æŠ¬å¤´"></td>-->
<!--			<td class="layui-td-gray-2">çº³ç¨äººè¯†åˆ«å·<font>*</font></td>-->
<!--			<td><input type="text" name="invoice_tax" class="layui-input" value=""  placeholder="è¯·è¾“å…¥çº³ç¨äººè¯†åˆ«å·ï¼Œä¸ªäººè¾“å…¥èº«ä»½è¯å·ç "lay-verify="required"  lay-reqText="è¯·è¾“å…¥çº³ç¨äººè¯†åˆ«å·ï¼Œä¸ªäººè¾“å…¥èº«ä»½è¯å·ç "></td>-->
<!--		</tr>-->
<!--		<tr class="invoice-qiye">-->
<!--			<td class="layui-td-gray">å¼€æˆ·è¡Œ<font>*</font></td>-->
<!--			<td><input type="text" name="invoice_bank" class="layui-input" value=""></td>-->
<!--			<td class="layui-td-gray">é“¶è¡Œè´¦å·<font>*</font></td>-->
<!--			<td><input type="text" name="invoice_account" class="layui-input" value=""></td>-->
<!--			<td class="layui-td-gray-2">é“¶è¡Œè¥ä¸šç½‘ç‚¹</td>-->
<!--			<td><input type="text" name="invoice_banking" class="layui-input" value=""></td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">ç”µè¯å·ç </td>-->
<!--			<td><input type="text" name="invoice_phone" class="layui-input" value=""></td>-->
<!--			<td class="layui-td-gray">åœ°å€</td>-->
<!--			<td colspan="3"><input type="text" name="invoice_address" class="layui-input" value=""></td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">å…³è”åˆåŒ</td>-->
<!--			<td colspan="5">-->
<!--				<input type="text" class="layui-input picker-oa" data-types="contract" name="contract_name" placeholder="è¯·é€‰æ‹©éœ€è¦å…³è”çš„åˆåŒ" readonly value="">		-->
<!--				<input type="hidden" class="layui-input" name="contract_id" value="0">		-->
<!--			</td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">å…³è”é¡¹ç›®</td>-->
<!--			<td colspan="5">-->
<!--				<input type="text" class="layui-input picker-oa" data-types="project" name="project_name" placeholder="è¯·é€‰æ‹©éœ€è¦å…³è”çš„é¡¹ç›®" readonly value="">		-->
<!--				<input type="hidden" class="layui-input" name="project_id" value="0">		-->
<!--			</td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">-->
<!--				<div class="layui-input-inline">é™„ä»¶</div>-->
<!--				<div class="layui-input-inline">-->
<!--					<button type="button" class="layui-btn layui-btn-xs" id="uploadBtn"><i class="layui-icon">î™”</i></button>-->
<!--				</div>-->
<!--			</td>-->
<!--			<td colspan="5">-->
<!--				<div class="layui-row" id="uploadBox">-->
<!--					<input type="hidden" data-type="file" name="file_ids" value="">-->
<!--				</div>-->
<!--			</td>-->
<!--		</tr>-->
<!--		<tr>-->
<!--			<td class="layui-td-gray">å¤‡æ³¨ä¿¡æ¯</td>-->
<!--			<td colspan="5"><textarea name="remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" class="layui-textarea"></textarea></td>-->
<!--		</tr>-->
<!--	</table>-->
<!--	<div id="checkBox" data-status="0" data-id="0" data-checkflowid="0" class="pt-3"></div>-->
<!--	<div class="pt-4">-->
<!--		<button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="webform">ç«‹å³æäº¤</button>-->
<!--		<button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>-->
<!--	</div>-->
<!--</form>-->
<!--{/block}-->
<!--&lt;!&ndash; /ä¸»ä½“ &ndash;&gt;-->

<!--&lt;!&ndash; è„šæœ¬ &ndash;&gt;-->
<!--{block name="script"}-->
<!--<script>-->
<!--	var moduleInit = ['tool','oaPicker','oaCheck','uploadPlus'];-->
<!--	function gouguInit() {-->
<!--		var form = layui.form, tool = layui.tool, oaPicker = layui.oaPicker,oaCheck = layui.oaCheck,uploadPlus = layui.uploadPlus;-->
<!--		//é€‰æ‹©æŠ¬å¤´ç±»å‹-->
<!--		form.on('radio(type)', function (data) {-->
<!--			if(data.value==2){-->
<!--				$('.invoice-qiye').hide();-->
<!--			}-->
<!--			else{-->
<!--				$('.invoice-qiye').show();-->
<!--			}-->
<!--		});-->
<!--		-->
<!--		//ç›¸å…³é™„ä»¶ä¸Šä¼ -->
<!--		var attachment = new uploadPlus();-->
<!--		-->
<!--		//å®¡æ‰¹ç›¸å…³-->
<!--		oaCheck.init({-->
<!--			check_name:'quote',-->
<!--			check_btn:0-->
<!--		});-->
<!--		-->
<!--		$('.customer-picker').on('click',function(){-->
<!--			let that = $(this),ids = [],titles=[],tax_num=[],tax_bank=[],tax_banksn=[],tax_mobile=[],tax_address=[];-->
<!--			let callback = function(data){-->
<!--				for ( var i = 0; i <data.length; i++){-->
<!--					ids.push(data[i].id);-->
<!--					titles.push(data[i].name);-->
<!--					tax_num.push(data[i].tax_num);-->
<!--					tax_bank.push(data[i].tax_bank);-->
<!--					tax_banksn.push(data[i].tax_banksn);-->
<!--					tax_mobile.push(data[i].tax_mobile);-->
<!--					tax_address.push(data[i].tax_address);-->
<!--				}-->
<!--				//that.val(titles.join(','));-->
<!--				//that.next().val(ids.join(','));-->
<!--				$('[name="invoice_title"]').val(titles.join(','));-->
<!--				$('[name="invoice_tax"]').val(tax_num.join(','));-->
<!--				$('[name="invoice_bank"]').val(tax_bank.join(','));-->
<!--				$('[name="invoice_account"]').val(tax_banksn.join(','));-->
<!--				$('[name="invoice_phone"]').val(tax_mobile.join(','));-->
<!--				$('[name="invoice_address"]').val(tax_address.join(','));-->
<!--			}-->
<!--			oaPicker.picker('customer',1,callback,{});-->
<!--		});-->
<!--		//ç›‘å¬æäº¤-->
<!--		form.on('submit(webform)', function (data) {-->
<!--			let callback = function (e) {-->
<!--				layer.msg(e.msg);-->
<!--				if (e.code == 0) {-->
<!--					let checkCallback = function (e) {-->
<!--						layer.msg(e.msg);-->
<!--						if (e.code == 0) {-->
<!--							tool.sideClose(1000);				-->
<!--						}-->
<!--					}-->
<!--					data.field.check_name = 'quote';-->
<!--					data.field.action_id = e.data.return_id;-->
<!--					oaCheck.submit(data.field,checkCallback);-->
<!--				}-->
<!--			}-->
<!--			let clickbtn = $(this);-->
<!--			tool.post("/finance/quote/add", data.field, callback,clickbtn);-->
<!--			return false;-->
<!--		});-->
<!--	}-->
<!--</script>-->
<!--{/block}-->
<!--&lt;!&ndash; /è„šæœ¬ &ndash;&gt;-->



{extend name="../../base/view/common/base" /}
<!-- ä¸»ä½“ -->
{block name="body"}
<form class="layui-form p-page">
    <h3 class="pb-3">æ–°å¢æŠ¥ä»·ç”³è¯·</h3>
    <table class="layui-table layui-table-form">
        <tr>
            <td class="layui-td-gray">æŠ¥ä»·ç¼–å·<font>*</font></td>
            <td>
                <input type="text" class="layui-input" name="quote_code" placeholder="è‡ªåŠ¨ç”Ÿæˆ"  lay-verify="required" value="{:get_quotecode('Q')}">
            </td>
            <td class="layui-td-gray">å®¢æˆ·åç§°<font>*</font></td>
            <td>
                <input type="text" class="layui-input customer-picker" name="customer_name" lay-verify="required" lay-reqText="è¯·é€‰æ‹©å®¢æˆ·" placeholder="è¯·é€‰æ‹©å®¢æˆ·" readonly>
                <input type="hidden" name="customer_id" value="0">
            </td>
            <td class="layui-td-gray">é¡¹ç›®åç§°</td>
            <td colspan="4">
                <input type="text" class="layui-input" name="project_name" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
            </td>
        </tr>

        <tr>
            <td class="layui-td-gray">äº§å“æ˜ç»†</td>
            <td colspan="5">
                <table class="layui-table" id="product-table">
                    <thead>
                    <tr>
                        <th>äº§å“ç±»å‹</th>
<!--                        <th>äº§å“åç§°</th>-->
                        <th>å†·å´æ–¹å¼</th>
                        <th>ç”µå †ç±»å‹</th>
                        <th class="head_polar_metrials_and_system_type">ææ¿ææ–™/ç³»ç»Ÿç±»å‹</th>
<!--                        <th class="head_system_type" style="display: none">ç³»ç»Ÿç±»å‹</th>-->
                        <th>åŠŸç‡</th>
<!--                        <th>äº§å“å‹å·</th>-->
                        <th>è®¢è´§æ•°é‡</th>
                        <th>å•ä½</th>
                        <th>å•ä»·</th>
                        <th>æ€»ä»·</th>
                        <th>å¤‡æ³¨</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="product-tbody">

                    <tr>
                        <td>
                            <select type="text" name="product_type[]" class="layui-select" placeholder="äº§å“ç±»å‹" lay-filter="productType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç”µå †">ç”µå †</option>
                                <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                            </select>
                        </td>
<!--                        <td>-->
                            <!--                <select name="product_name[]" class="layui-select">-->
                            <!--                    <option value="">è¯·é€‰æ‹©</option>-->
                            <!--                    <option value="é£å†·ç³»ç»Ÿ">é£å†·ç³»ç»Ÿ</option>-->
                            <!--                    <option value="æ°´å†·ç³»ç»Ÿ">æ°´å†·ç³»ç»Ÿ</option>-->
                            <!--                </select>-->
<!--                            <input type="text" name="product_name[]" class="layui-input" placeholder="äº§å“åç§°">-->
<!--                        </td>-->
                        <td>
                            <select name="cooling_method[]" lay-filter="cooling_method" id="cooling_method">
                                <option value="">è¯·é€‰æ‹©</option>
                                    <option value="æ°´å†·" data-fulltext="æ°´å†·">æ°´å†·</option>
                                    <option value="é£å†·-å¼€æ”¾å¼" data-fulltext="é£å†·">é£å†·</option>
                            </select>

                        </td>
                        <td>
                            <select type="text" name="stack_type[]" class="layui-input layui-disabled" placeholder="ç”µå †ç±»å‹" disabled>
                                <option value="">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>
                                <!--                                    <option value="å¼€æ”¾å¼" data-fulltext="å¼€æ”¾å¼">å¼€æ”¾å¼</option>-->
                                <!--                                    <option value="å°é—­å¼" data-fulltext="å°é—­å¼">å°é—­å¼</option>-->
                            </select>
                        </td>
                        <td >
                        <select type="text" name="polar_metrials_and_system_type[]" class="layui-select  layui-disabled" placeholder="ææ¿ææ–™/ç³»ç»Ÿç±»å‹" disabled>
                            <option value="">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>
                            <option value="çŸ³å¢¨ææ¿">çŸ³å¢¨ææ¿</option>
                            <option value="é‡‘å±ææ¿">é‡‘å±ææ¿</option>
                        </select>
                        </td>
                        <td style="display: none">
<!--                        <select type="text" name="system_type[]" class="layui-select" placeholder="ç³»ç»Ÿç±»å‹">-->
<!--                            <option>å‘ç”µç³»ç»Ÿ</option>-->
<!--                            <option>åŠ¨åŠ›ç³»ç»Ÿ</option>-->
<!--                        </select>-->
                        </td>

                        <td>
                        <input type="text" name="power_rate[]" class="layui-select" placeholder="ä¾‹å¦‚ï¼ˆ100W/1kW/1.5kWï¼‰">
<!--                            <option value="">è¯·é€‰æ‹©</option>-->
<!--                            <option value="100">100W</option>-->
<!--                            <option value="150">150W</option>-->
<!--                            <option value="200">200W</option>-->
<!--                        </select>-->
                        </td>
<!--                        <td>-->
                            <!--                <select name="product_model[]" class="layui-select">-->
                            <!--                    <option value="">è¯·é€‰æ‹©</option>-->
                            <!--                    <option value="å‹å·1">å‹å·1</option>-->
                            <!--                    <option value="å‹å·2">å‹å·2</option>-->
                            <!--                </select>-->
<!--                            <input type="text" name="product_model[]" class="layui-input" placeholder="äº§å“å‹å·">-->
<!--                        </td>-->
                        <td><input type="number" name="quantity[]" class="layui-input" placeholder="æ•°é‡"></td>
                        <td>
                            <select name="unit[]" class="layui-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="å°">å°</option>
                                <option value="åª">åª</option>
                                <option value="ä¸ª">ä¸ª</option>
                                <option value="ç›’">ç›’</option>
                                <option value="ç®±">ç®±</option>
                                <option value="ä»¶">ä»¶</option>
                            </select>
                        </td>
                        <td><input type="number" name="price[]" class="layui-input" placeholder="å•ä»·"></td>
                        <td><input type="number" name="total[]" class="layui-input" placeholder="(è‡ªåŠ¨è®¡ç®—)" readonly></td>
                        <td><input type="text" name="remark[]" class="layui-input" placeholder="å¤‡æ³¨"></td>
                        <td><button type="button" class="layui-btn layui-btn-danger layui-btn-xs del-row" style="visibility: hidden">åˆ é™¤</button></td>
                    </tr>
                    </tbody>
                </table>
                <button type="button" class="layui-btn layui-btn-sm" id="add-row">æ–°å¢ä¸€è¡Œ</button>
            </td>
        </tr>

        <tr>
            <td class="layui-td-gray">ç¨ç‡<font>*</font></td>
            <td>
                <select name="tax_rate" lay-verify="required" lay-filter="tax_rate">
                    <option value="0.13">13%</option>
                    <option value="0.09">9%</option>
                    <option value="0.06">6%</option>
                    <option value="0">å…ç¨</option>
                </select>
            </td>
            <td class="layui-td-gray">ä»˜æ¬¾æ–¹å¼</td>
            <td colspan="3">
                <input type="text" class="layui-input" name="payment_terms" placeholder="ä¾‹å¦‚ï¼š30%é¢„ä»˜æ¬¾ï¼Œ70%éªŒæ”¶å">
            </td>
        </tr>
        <tr>
            <td class="layui-td-gray">æ€»é‡‘é¢ï¼ˆä¸å«ç¨ï¼‰<font>*</font></td>
            <td>
                <input type="text" class="layui-input" name="amount_total_without_tax" lay-verify="required|number" placeholder="ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" lay-reqText="" readonly>
            </td>
            <td class="layui-td-gray" >æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰</td>
            <td colspan="3">
                <input type="text" class="layui-input" name="amount_total_with_tax" lay-verify="number" placeholder="ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" readonly>
            </td>
<!--            <td class="layui-td-gray">åˆ©æ¶¦</td>-->
<!--            <td>-->
<!--                <input type="text" class="layui-input" name="profitâ€œ lay-verify="number" placeholder="ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" readonly>-->
<!--            </td>-->
<!--            <td class="layui-td-gray">åˆ©æ¶¦ç‡</td>-->
<!--            <td>-->
<!--                <input type="text" class="layui-input" name="profit_rate" readonly>-->
<!--            </td>-->
        </tr>
        <tr>
            <td class="layui-td-gray">å…³è”åˆåŒ</td>
            <td colspan="5">
                <input type="text" class="layui-input picker-oa" data-types="contract" name="contract_name" placeholder="è¯·é€‰æ‹©éœ€è¦å…³è”çš„åˆåŒ" readonly>
                <input type="hidden" name="contract_id" value="0">
            </td>
        </tr>
        <tr>
            <td class="layui-td-gray">å…³è”é¡¹ç›®</td>
            <td colspan="5">
                <input type="text" class="layui-input picker-oa" data-types="project" name="related_project" placeholder="è¯·é€‰æ‹©éœ€è¦å…³è”çš„é¡¹ç›®" readonly>
                <input type="hidden" name="project_id" value="0">
            </td>
        </tr>
        <tr>
            <td class="layui-td-gray">é™„ä»¶</td>
            <td colspan="5">
                <button type="button" class="layui-btn layui-btn-xs" id="uploadBtn"><i class="layui-icon">î™”</i> ä¸Šä¼ é™„ä»¶</button>
                <div class="layui-row mt-2" id="uploadBox">
                    <input type="hidden" data-type="file" name="file_ids" value="">
                </div>
            </td>
        </tr>
        <tr>
            <td class="layui-td-gray">å¤‡æ³¨ä¿¡æ¯</td>
            <td colspan="5">
                <textarea name="remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" class="layui-textarea"></textarea>
            </td>
        </tr>
    </table>
    <div id="checkBox" data-status="0" data-id="0" data-checkflowid="0" class="pt-3"></div>
    <div class="pt-4">
        <button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="webform">ç«‹å³æäº¤</button>
        <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
    </div>
</form>
{/block}

<!-- è„šæœ¬ -->
{block name="script"}
<script>
    var moduleInit = ['tool','oaPicker','oaCheck','uploadPlus'];
    function gouguInit() {
        var form = layui.form, tool = layui.tool, oaPicker = layui.oaPicker, oaCheck = layui.oaCheck, uploadPlus = layui.uploadPlus;

        // å®¢æˆ·é€‰æ‹©
        $('.customer-picker').on('click', function(){
            oaPicker.picker('customer', 1, function(data){
                if(data.length){
                    $('[name="customer_name"]').val(data[0].name);
                    $('[name="customer_id"]').val(data[0].id);
                }
            });
        });

        // é™„ä»¶ä¸Šä¼ 
        var attachment = new uploadPlus();

        // å®¡æ‰¹åˆå§‹åŒ–
        oaCheck.init({
            check_name:'quote',
            check_btn:0
        });

        // åˆ©æ¶¦(ç‡)è®¡ç®—
        // $('[name="amount_total"], [name="cost_total"]').on('input', function(){
        //     var total = parseFloat($('[name="amount_total"]').val()) || 0;
        //     var cost = parseFloat($('[name="cost_total"]').val()) || 0;
        //     if(cost > 0){
        //         var rate = ((total - cost) / cost * 100).toFixed(2);
        //         $('[name="profit"]').val(total - cost);
        //         // $('[name="profit_rate"]').val(rate + '%');
        //         $('[name="profit_rate"]').val(rate + '%');
        //     }else{
        //         $('[name="profit_rate"]').val('');
        //     }
        // });

        // æäº¤è¡¨å•
        form.on('submit(webform)', function (data) {
            // å¤„ç† profit_rate å­—æ®µï¼Œå°†å‰é¢å¸¦ç™¾åˆ†æ¯”çš„å€¼è½¬ä¸ºå°æ•° 0.3333
            // if (data.field.profit_rate && data.field.profit_rate.includes('%')) {
            //     const raw = parseFloat(data.field.profit_rate.replace('%', ''));  // å¾—åˆ° 33.33
            //     if (!isNaN(raw)) {
            //         data.field.profit_rate = (raw / 100).toFixed(4);  // è½¬ä¸º 0.3333ï¼Œä¿ç•™ 4 ä½å°æ•°
            //     } else {
            //         data.field.profit_rate = 0;
            //     }
            // }
            function restructureFormData(rawData) {
                const result = {};
                const productDetail = [];

                for (const key in rawData) {
                    const match = key.match(/^(\w+)\[(\d+)\]$/);
                    if (match) {
                        const field = match[1];
                        const index = parseInt(match[2]);

                        if (!productDetail[index]) productDetail[index] = {};
                        productDetail[index][field] = rawData[key];
                    } else {
                        result[key] = rawData[key];
                    }
                }

                // ç±»å‹è½¬æ¢ï¼ˆå¯é€‰ï¼‰
                for (const item of productDetail) {
                    item.quantity = parseFloat(item.quantity) || 0;
                    item.price = parseFloat(item.price) || 0;
                    item.total = parseFloat(item.total) || 0;
                }

                result.product_detail = productDetail;

                return result;
            }


            let callback = function (e) {
                layer.msg("callbackï¼š"+e.msg);
                console.log(restructureFormData(data.field)); // è½¬ä¸ºå­—ç¬¦ä¸²æŸ¥çœ‹å†…å®¹
                console.log("Raw:"+data.field); // è½¬ä¸ºå­—ç¬¦ä¸²æŸ¥çœ‹å†…å®¹
                if (e.code == 0) {
                    let checkCallback = function (e) {
                        layer.msg(e.msg);
                        if (e.code == 0) {
                            tool.sideClose(1000);
                        }
                        else{
                            layer.msg(e.msg)
                        }
                    }
                    data.field.check_name = 'quote';
                    data.field.action_id = e.data.return_id;
                    oaCheck.submit(restructureFormData(data.field), checkCallback);
                }
            }
            let clickbtn = $(this);
            tool.post("/finance/quote/add", restructureFormData(data.field), callback, clickbtn);
            return false;
        });

        // æ›´æ–°æ‰€æœ‰ select çš„ fulltext æ˜¾ç¤º
        function updateSelectedFullText() {
            $('.layui-form-select').each(function(){
                var $select = $(this);
                var value = $select.find('dl dd.layui-this').attr('lay-value');
                var $option = $select.prev('select').find(`option[value="${value}"]`);
                var fullText = $option.attr('data-fulltext');
                if (fullText) {
                    $select.find('.layui-select-title input').val(fullText);
                }
            });
        }

        // æ·»åŠ ä¸€è¡Œ
        $('#add-row').on('click', function () {
            var newRow = `
        <tr>
         <td>
                            <select type="text" name="product_type[]" class="layui-select" placeholder="äº§å“ç±»å‹" lay-filter="productType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç”µå †">ç”µå †</option>
                                <option value="ç³»ç»Ÿ">ç³»ç»Ÿ</option>
                            </select>
                        </td>
<!--            <td>-->
<!--                <select name="product_name[]" class="layui-select">-->
<!--                    <option value="">è¯·é€‰æ‹©</option>-->
<!--                    <option value="é£å†·ç³»ç»Ÿ">é£å†·ç³»ç»Ÿ</option>-->
<!--                    <option value="æ°´å†·ç³»ç»Ÿ">æ°´å†·ç³»ç»Ÿ</option>-->
<!--                </select>-->
<!--                    <input type="text" name="product_name[]" class="layui-input" placeholder="äº§å“åç§°">-->
<!--            </td>-->
<!--            <td>-->
<!--&lt;!&ndash;                <select name="product_model[]" class="layui-select">&ndash;&gt;-->
<!--&lt;!&ndash;                    <option value="">è¯·é€‰æ‹©</option>&ndash;&gt;-->
<!--&lt;!&ndash;                    <option value="å‹å·1">å‹å·1</option>&ndash;&gt;-->
<!--&lt;!&ndash;                    <option value="å‹å·2">å‹å·2</option>&ndash;&gt;-->
<!--&lt;!&ndash;                </select>&ndash;&gt;-->
<!--                    <input type="text" name="product_model[]" class="layui-input" placeholder="äº§å“åç§°">-->
<!--            </td>-->
            <td>
                      <select name="cooling_method[]" lay-filter="cooling_method" id="cooling_method">
                                <option value="">è¯·é€‰æ‹©</option>
                                    <option value="æ°´å†·" data-fulltext="æ°´å†·">æ°´å†·</option>
                                    <option value="é£å†·" data-fulltext="é£å†·">é£å†·</option>
                            </select>
             </td>
             <td>
                <select type="text" name="stack_type[]" lay-filter="stack_type" class="layui-input layui-disabled" placeholder="ç”µå †ç±»å‹" readonly>
                    <option value="">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>
<!--                                    <option value="å¼€æ”¾å¼" data-fulltext="å¼€æ”¾å¼">å¼€æ”¾å¼</option>-->
<!--                                    <option value="å°é—­å¼" data-fulltext="å°é—­å¼">å°é—­å¼</option>-->
                    </select>
              </td>
              <td>
             <select type="text" name="polar_metrials_and_system_type[]" class="layui-select layui-disabled" placeholder="ææ¿ææ–™/ç³»ç»Ÿç±»å‹" disabled>
                            <option value="">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>
                            <option value="çŸ³å¢¨ææ¿">çŸ³å¢¨ææ¿</option>
                            <option value="é‡‘å±ææ¿">é‡‘å±ææ¿</option>
                        </select>
              </td>

               </td>
               <td>
                        <input type="text" name="power_rate[]" class="layui-select" placeholder="ä¾‹å¦‚ï¼ˆ100W/1kW/1.5kWï¼‰">
<!--                            <option value="">è¯·é€‰æ‹©</option>-->
<!--                            <option value="100">100W</option>-->
<!--                            <option value="150">150W</option>-->
<!--                            <option value="200">200W</option>-->
<!--                        </select>-->
                 </td>
<!--                 <td>-->
<!--                        <input type="text" name="product_model[]" class="layui-input" placeholder="äº§å“å‹å·">-->
<!--                  </td>-->
            <td><input type="number" name="quantity[]" class="layui-input" placeholder="æ•°é‡"></td>
            <td>
                <select name="unit[]" class="layui-select">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="å°">å°</option>
                    <option value="åª">åª</option>
                    <option value="ä¸ª">ä¸ª</option>
                    <option value="ç›’">ç›’</option>
                    <option value="ç®±">ç®±</option>
                    <option value="ä»¶">ä»¶</option>
                </select>
            </td>
            <td><input type="number" name="price[]" class="layui-input" placeholder="å•ä»·"></td>
            <td><input type="number" name="total[]" class="layui-input" placeholder="(è‡ªåŠ¨è®¡ç®—)" readonly></td>
            <td><input type="text" name="remark[]" class="layui-input" placeholder="å¤‡æ³¨"></td>
            <td><button type="button" class="layui-btn layui-btn-danger layui-btn-xs del-row">åˆ é™¤</button></td>
        </tr>`;
            $('#product-tbody').append(newRow);
            form.render('select'); // é‡æ–°æ¸²æŸ“ select
            // æ¸²æŸ“åå®æ—¶æ›´æ–° fulltext æ˜¾ç¤º
            // updateSelectedFullText();

        });


        // ç›‘å¬ select[name="product_type[]"]
        // form.on('select(productType)', function (data) {
        //     var selectedValue = data.value;
        //
        //     if (selectedValue === 'ç”µå †') {
        //         // éšè—ç³»ç»Ÿç±»å‹åˆ—ï¼ˆè¡¨å¤´å’Œå¯¹åº”åˆ—ï¼‰
        //         // $('.head_system_type').hide();
        //         $('[name="system_type[]"]').closest('td,th').hide();
        //
        //         // æ˜¾ç¤ºææ¿ææ–™åˆ—
        //         $('.head_polar_metrials').show();
        //         $('[name="polar_metrial[]"]').closest('td,th').show();
        //     } else if (selectedValue === 'ç³»ç»Ÿ') {
        //         // éšè—ææ¿ææ–™åˆ—
        //         // $('.head_polar_metrials').hide();
        //         $('[name="polar_metrial[]"]').closest('td,th').hide();
        //
        //         // æ˜¾ç¤ºç³»ç»Ÿç±»å‹åˆ—
        //         $('.head_system_type').show();
        //         $('[name="system_type[]"]').closest('td,th').show();
        //     } else {
        //         // å¦‚æœé€‰æ‹©äº†å…¶ä»–æˆ–ç©ºï¼Œå…¨éƒ¨æ˜¾ç¤º
        //         $('.head_system_type, .head_polar_metrials').show();
        //         $('[name="system_type"], [name="polar_metrial[]"]').closest('td,th').show();
        //     }
        // });
        form.on('select(productType)', function (data) {
            var selectedValue = data.value;

            // è·å–å½“å‰è¡Œï¼ˆtableä¸­çš„trï¼‰
            var $tr = $(data.elem).closest('tr');

            // è·å–åŒä¸€è¡Œçš„å¦ä¸€ä¸ª selectï¼ˆææ¿ææ–™/ç³»ç»Ÿç±»å‹ï¼‰
            var $targetSelect = $tr.find('select[name="polar_metrials_and_system_type[]"]');
            var $stacktypeSelect = $tr.find('select[name="stack_type[]"]');
            // var $polarSelect = $tr.find('select[name="polar_metrials_and_system_type[]"]');
            // var $collingtargetSelect = $tr.find('select[name="cooling_method[]"]');

            if (selectedValue === 'ç”µå †') {
                // éšè—ç³»ç»Ÿç±»å‹åˆ—ï¼ˆè¡¨å¤´å’Œå¯¹åº”åˆ—ï¼‰
                $('[name="system_type[]"]').closest('td,th').hide();

                // æ˜¾ç¤ºææ¿ææ–™åˆ—
                $('.head_polar_metrials').show();
                $('[name="polar_metrial[]"]').closest('td,th').show();

                // è®¾ç½®ææ¿é€‰é¡¹
                $targetSelect.html(`
        <option value="">è¯·é€‰æ‹©</option>
        <option value="çŸ³å¢¨ææ¿">çŸ³å¢¨ææ¿</option>
        <option value="é‡‘å±ææ¿">é‡‘å±ææ¿</option>
      `);

                // $collingtargetSelect.html(`<option value="">è¯·é€‰æ‹©</option>
                //                 <optgroup label="æ°´å†·">
                //                     <option value="æ°´å†·" data-fulltext="æ°´å†·">æ°´å†·</option>
                //                 </optgroup>
                //                 <optgroup label="é£å†·">
                //                     <option value="é£å†·-å¼€æ”¾å¼" data-fulltext="é£å†·-å¼€æ”¾å¼">å¼€æ”¾å¼</option>
                //                     <option value="é£å†·-å°é—­å¼" data-fulltext="é£å†·-å°é—­å¼">å°é—­å¼</option>
                //                 </optgroup>`)
                $targetSelect.prop('disabled', false);
                form.render();

            } else if (selectedValue === 'ç³»ç»Ÿ') {

                // éšè—ææ¿ææ–™åˆ—
                // $('[name="polar_metrial[]"]').closest('td,th').hide();

                // æ˜¾ç¤ºç³»ç»Ÿç±»å‹åˆ—
                // $('.head_system_type').show();
                // $('[name="system_type[]"]').closest('td,th').show();

                // è®¾ç½®ç³»ç»Ÿé€‰é¡¹
                $targetSelect.html(`
        <option value="">è¯·é€‰æ‹©</option>
        <option value="å‘ç”µç³»ç»Ÿ">å‘ç”µç³»ç»Ÿ</option>
        <option value="åŠ¨åŠ›ç³»ç»Ÿ">åŠ¨åŠ›ç³»ç»Ÿ</option>
      `);

                // $collingtargetSelect.html(`<option value="">è¯·é€‰æ‹©</option>
                //                 <optgroup label="æ°´å†·">
                //                     <option value="æ°´å†·" data-fulltext="æ°´å†·">æ°´å†·</option>
                //                 </optgroup>
                //                 <optgroup label="é£å†·">
                //                     <option value="é£å†·-å¼€æ”¾å¼" data-fulltext="é£å†·-å¼€æ”¾å¼">å¼€æ”¾å¼</option>
                //                     <option value="é£å†·-å°é—­å¼" data-fulltext="é£å†·-å°é—­å¼">å°é—­å¼</option>
                //                 </optgroup>`)

                $targetSelect.prop('disabled', false);
                form.render();
            }
            else {
                // æ˜¾ç¤ºæ‰€æœ‰åˆ—
                // $('.head_system_type, .head_polar_metrials').show();
                // $('[name="system_type[]"], [name="polar_metrial[]"]').closest('td,th').show();

                // æ¸…ç©ºä¸‹æ‹‰æ¡†
                // $targetSelect.html(`<option value="">è¯·é€‰æ‹©</option>`);
                $targetSelect.html(`<option value="">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>`)
                // è®¾ç½®ä¸ºç¦ç”¨
                $targetSelect.prop('disabled', true);
                console.log($targetSelect.prop('disabled'))
                // é‡æ–°æ¸²æŸ“ layui çš„ selectï¼Œè®©ç¦ç”¨ç”Ÿæ•ˆ
                form.render('select');

                // $collingtargetSelect.html(`<option value="">è¯·é€‰æ‹©</option>`);

            }

                $tr.find('select').each(function () {
                    var name = $(this).attr('name');
                    var value = $(this).val();  // è·å–å½“å‰ select çš„å€¼
                    console.log('product_type[] value:', value);
                    // ä¸‹é¢è¡¥å……è¦è·å–product_type[]çš„selectçš„valueå€¼
                    // å¦‚æœæ˜¯ product_type[]ï¼Œè·å–å€¼å¹¶è·³è¿‡åç»­æ“ä½œ
                    if (name === 'product_type[]' && value === "") {
                        // console.log('product_type[] value:', value); // ä½ å¯ä»¥ç”¨è¿™ä¸ªå€¼åšåç»­æ“ä½œ
                        $stacktypeSelect.html(`<option>ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>`);
                        $(this).prop('disabled', false); // å¦‚æœä¹‹å‰è¢«ç¦ç”¨äº†ï¼Œä¹Ÿæ¢å¤å¯ç”¨
                        // return; // è·³è¿‡å…¶ä½™å¤„ç†
                    }
                    //è¡¥å……å®Œæ¯•
                    if (name !== 'product_type[]') {
                        if (name === 'stack_type[]'){
                            // $(this).val('ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰');
                            $stacktypeSelect.html(`<option>ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>`);
                            $(this).prop('disabled', true); // å¦‚æœä¹‹å‰è¢«ç¦ç”¨äº†ï¼Œä¹Ÿæ¢å¤å¯ç”¨
                        }
                        // else if (name === 'polar_metrials_and_system_type[]' ){
                        //     $targetSelect.html(`<option>ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>`);
                        // }
                        else{
                            $(this).val(''); // é‡ç½®ä¸ºç¬¬ä¸€ä¸ª value ä¸ºç©ºçš„ option
                            // $(this).prop('disabled', false); // å¦‚æœä¹‹å‰è¢«ç¦ç”¨äº†ï¼Œä¹Ÿæ¢å¤å¯ç”¨
                        }

                    }
                });
            // åˆ·æ–° Layui æ¸²æŸ“çš„ select
            form.render('select');
            // æ¸²æŸ“åå®æ—¶æ›´æ–° fulltext æ˜¾ç¤º
            // updateSelectedFullText();
        });


        // åˆ é™¤ä¸€è¡Œ
        $(document).on('click', '.del-row', function () {
            $(this).closest('tr').remove();
            calculateAmountTotal(); // âœ… åˆ é™¤æ—¶é‡æ–°æ±‡æ€»
        });

        // è‡ªåŠ¨è®¡ç®—æ€»ä»·ã€å«ç¨ä»·
        $(document).on('input', 'input[name="quantity[]"], input[name="price[]"]', function () {
            var $tr = $(this).closest('tr'); // å½“å‰è¡Œ
            var quantity = parseFloat($tr.find('input[name="quantity[]"]').val()) || 0;
            var price = parseFloat($tr.find('input[name="price[]"]').val()) || 0;
            var total = (quantity * price).toFixed(2); // ä¿ç•™ä¸¤ä½å°æ•°
            $tr.find('input[name="total[]"]').val(total);
            calculateAmountTotal(); // âœ… è‡ªåŠ¨è®¡ç®—æ±‡æ€»
        });

        $(document).on('click', '.layui-form-select', function () {
            // è·å–å¯¹åº”çš„åŸå§‹ <select> å…ƒç´ 
            var $select = $(this).prev('select');
            var selectName = $select.attr('name');
            var value = $select.val();  // âœ… æ­£ç¡®è·å–é€‰ä¸­å€¼
            console.log('å½“å‰å€¼:', value);

            // åˆ¤æ–­æ˜¯å¦è¢«ç¦ç”¨
            if ($select.prop('disabled')) {
                if (selectName === 'stack_type[]' && value !== '/') {
                    // å¼¹å‡ºæç¤º
                    layer.msg('è¯·é€‰æ‹©å†·å´æ–¹å¼', { icon: 2,anim: 6 });
                }else if(selectName === 'polar_metrials_and_system_type[]' && value !== '/'){
                    layer.msg('è¯·é€‰æ‹©äº§å“ç±»å‹', { icon: 2,anim: 6 });
                }else{
                    layer.msg('è¯¥é¡¹æ— éœ€å¡«å†™', { icon: 6,anim: 0 });
                }

                return false; // é˜»æ­¢ä¸‹æ‹‰æ¡†å±•å¼€
            }
        });





        // ğŸ” ç›‘å¬ç¨ç‡ä¸‹æ‹‰æ¡†å˜åŒ–
        layui.use(['form'], function () {
            var form = layui.form;

            // Layui é£æ ¼ç›‘å¬ select
            form.on('select(tax_rate)', function (data) {
                calculateAmountTotal();
            });
        });

        //ç›‘å¬select
        layui.use(['form', 'jquery'], function(){
            var form = layui.form;
            var $ = layui.jquery;


            form.render();  // âš ï¸ ä¸€å®šè¦åŠ ï¼Œç¡®ä¿ select è¢« Layui æ¸²æŸ“

        //     form.on('select(cooling_method)', function(data){
        //     var selectedElem = data.elem[data.elem.selectedIndex];
        //     var fullText = selectedElem.getAttribute('data-fulltext');
        //
        //     // é€‰ä¸­çš„é‚£ä¸€é¡¹æ˜¾ç¤ºå€¼
        //     var $inputElem = $(data.othis).find('.layui-select-title input');
        //     if (fullText) {
        //     $inputElem.val(fullText);
        //     }
        // });

            form.on('select(cooling_method)', function(data) {
                var selectedValue = data.value;
                // var $coolingMethod = $('#cooling_method');
                // è·å–å½“å‰è¡Œï¼ˆtableä¸­çš„trï¼‰
                var $tr = $(data.elem).closest('tr');
                var $stackType = $tr.find('select[name="stack_type[]"]');

                if (selectedValue === 'æ°´å†·') {
                    // æ¸…ç©ºé€‰é¡¹å¹¶æ·»åŠ â€œæ— éœ€å¡«å†™â€
                    $stackType.empty();
                    $stackType.append('<option value="/">ï¼ˆæ— éœ€å¡«å†™ï¼‰</option>');

                    // è®¾ç½®ä¸ºç¦ç”¨
                    $stackType.prop('disabled', true);
                } else if (selectedValue == ""){
                    $stackType.empty();
                    // è®¾ç½®ä¸ºç¦ç”¨
                    $stackType.prop('disabled', true);
                    $stackType.append('<option value="/">ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰</option>');
                }
                else {
                    // æ¢å¤é»˜è®¤é€‰é¡¹
                    $stackType.empty();
                    // $stackType.append('<option value="">è¯·é€‰æ‹©</option>');
                    $stackType.append('<option value="å¼€æ”¾å¼">å¼€æ”¾å¼</option>');
                    $stackType.append('<option value="å°é—­å¼">å°é—­å¼</option>');


                    // å¯ç”¨é€‰æ‹©æ¡†
                    $stackType.prop('disabled', false);
                }

                // é‡æ–°æ¸²æŸ“ select ä»¥ç”Ÿæ•ˆ layui æ ·å¼
                form.render('select');
            });




        });



        // æ±‡æ€»æ‰€æœ‰äº§å“çš„æ€»ä»·
        function calculateAmountTotal() {
            var total = 0;
            $('input[name="total[]"]').each(function () {
                var val = parseFloat($(this).val()) || 0;
                total += val;
            });
            $('input[name="amount_total_without_tax"]').val(total.toFixed(2));
            // è®¡ç®—å«ç¨ä»·æ ¼
            var taxRate = parseFloat($('select[name="tax_rate"]').val()) || 0;
            var totalWithTax = total * (1 + taxRate);
            $('input[name="amount_total_with_tax"]').val(totalWithTax.toFixed(2));
        }

    }
</script>

{/block}
