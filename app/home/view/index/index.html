{extend name="../../base/view/common/base" /}
{block name="style"}
<link rel="stylesheet" href="{__GOUGU__}/gougu/css/layout.css" media="all">
{/block}
<!-- 主体 -->
{block name="body"}
<div class="layui-layout-body">
    <div id="GouguApp">
        <div class="layui-layout gg-layout layout-menu-{$system.menu_mode|default='classical'}">
            <div class="layui-header">
                <!-- 头部区域 -->
                <div class="layui-layout-left">
                    <span class="gg-head-item">
                        <a href="javascript:;" gg-event="shrink" title="侧边伸缩"><i class="layui-icon layui-icon-shrink-right"></i></a>
                    </span>
                    <span class="gg-head-item gg-head-cache">
                        <a href="javascript:;" gg-event="cache" data-href="/api/index/cache_clear" title="清空缓存"><i class="layui-icon layui-icon-fonts-clear"></i></a>
                    </span>
<!--                    <span class="gg-head-item gg-head-home">-->
<!--                        <a href="https://www.gougucms.com/home/pages/detail/s/gouguoa.html" target="_blank" title="前台首页"><i class="layui-icon layui-icon-website"></i></a>-->
<!--                    </span>-->
<!--					<span class="gg-head-item gg-head-home">-->
<!--                        <a class="tab-a" data-href="/crud/crud/index" data-title="简单CRUD" title="简单CRUD"><i class="layui-icon layui-icon-template"></i></a>-->
<!--                    </span>-->
                </div>

                <div class="layui-layout-right">
                    <span class="gg-head-item gg-head-refresh">
                        <a href="javascript:;" class="refreshThis" gg-event="refresh" title="刷新页面">
                            <i class="layui-icon layui-icon-refresh"></i>
                        </a>
                    </span>
                    <span class="gg-head-item gg-head-screen" title="切换全屏">
                        <a href="javascript:;" gg-event="screen" data-screen="full">
                            <i class="fullScreen layui-icon layui-icon-screen-full"></i>
                        </a>
                    </span>
					<span class="gg-head-item gg-head-set">
                        <a href="javascript:;" id="theme" title="切换主题">
<!--                            <i class="layui-icon layui-icon-set"></i>-->
                            <i>
                           <svg t="1753489140089" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2757" width="20" height="21" style="
    margin-top: 12px;
"><path d="M947.575912 356.451318l-0.167823-0.163729a10.42749 10.42749 0 0 0-0.293689-0.270153L758.030951 166.949336c-18.015306-28.443819-48.545646-45.387723-81.914638-45.387723h-42.083467c-1.540076-0.357134-3.15383-0.532119-4.884241-0.532119-1.706875 0-3.261277 0.168846-4.631484 0.317225-1.022283 0.110517-1.987261 0.214894-2.753717 0.214894-9.875928 0-18.965957 3.302209-26.198685 8.919137l-16.525372 27.490098c-5.010107 32.832779-32.620955 56.663534-65.653279 56.663534-17.821901 0-34.603099-7.173376-47.25321-20.198018l-0.36225-0.35611c-9.369392-8.734942-15.789615-19.836791-18.565845-32.104186l-0.515746-2.272763a85.938278 85.938278 0 0 1-0.055259-0.73678 47.273676 47.273676 0 0 0-0.237407-2.580779l-0.138146-0.822738a42.400692 42.400692 0 0 0-2.071172-6.885827l-12.821003-17.452487c-7.450692-6.068206-16.916275-9.66308-27.01426-9.663081-0.765433 0-1.731434-0.105401-2.753717-0.214894-1.370207-0.148379-2.923586-0.317225-4.631484-0.317225-1.730411 0-3.344165 0.174985-4.883218 0.532119h-42.085514c-30.16809 0-58.115606 13.889335-76.788897 38.132482L77.099471 355.780029l-1.257644 0.884137-0.499373 0.913812c-15.59928 16.768919-15.250332 43.113937 1.057075 59.45102l3.021823 3.004427L214.764853 555.376926c7.865131 7.877411 18.332531 12.216229 29.475312 12.21623 2.889817 0 5.754051-0.288572 8.559957-0.855484v314.431295h5.89322c7.504928 13.285584 21.572318 21.804608 36.948517 21.804609H730.470245c15.371082 0 29.437449-8.510838 36.945447-21.784142h5.897314V567.120388c2.111081 0.316202 4.242627 0.475837 6.378267 0.475838 11.186783 0 21.674649-4.342912 29.519314-12.21623l138.366348-138.347928c16.696264-16.70138 16.696264-43.878346-0.001023-60.58075zM657.400043 190.769858l0.527002 0.363274c2.045589 1.414209 4.14746 2.867304 6.370082 4.003174l6.360871 5.589298 186.009437 186.02888-83.354429 83.350337v-11.211343l-85.687568-85.694731v444.081121H338.488713V371.09176l-85.688591 85.688591v15.456017l-83.535555-83.516112-1.974981-1.980098L352.481402 201.520713c2.850931-1.696642 5.79703-4.242627 9.110495-7.105838 1.266853-1.094938 3.045359-2.63092 4.774746-4.02671l7.181563 11.373025c23.808242 56.19486 78.472236 92.454692 139.511428 92.454692 29.356608 0 61.375859-12.966313 90.157369-36.510542 22.733771-18.597567 42.059931-42.560328 54.18304-66.935482z" p-id="2758" style="margin-top: 12px"></path></svg>                    </i>
                        </a>
                    </span>
					<span class="gg-head-item gg-head-set">
                        <a href="/home/login/lock.html" title="锁屏">
                            <i class="iconfont icon-suozhu" style="font-size:21px; font-weight:800"></i>
                        </a>
                    </span>
                    <span class="gg-head-item gg-head-message">
                        <a href="javascript:;" data-href="/home/message/inbox" data-id="1000" data-title="消息中心" class="tab-a" title="消息中心">
                            <i class="layui-icon layui-icon-notice"></i>
                            <!-- 如果有新消息，则显示 -->
                            <div class="gg-message-num" id="msgNum" style="display: none;"><span>0</span></div>
                        </a>
                    </span>
                    <span class="gg-head-item gg-head-avatar">
                        <ul class="layui-nav">
                            <li class="layui-nav-item">
                                <a href="javascript:;">
									<img src="{$login_admin.thumb}" onerror="javascript:this.src='{__IMG__}/nonepic360x360.jpg';this.onerror=null;">
                                    <cite>{$login_admin.nickname}</cite>
                                </a>
                                <dl class="layui-nav-child" style="text-align: center; cursor: pointer;">
                                    <dd><a data-href="/home/index/edit_personal" data-id="1001" data-title="基本资料" class="tab-a">基本资料</a></dd>
                                    <dd><a data-href="/home/index/edit_password" data-id="1002" data-title="修改密码" class="tab-a">修改密码</a></dd>
                                    <hr>
                                    <dd gg-event="logout"><a>退出</a></dd>
                                </dl>
                            </li>
                        </ul>
                    </span>
                </div>
            </div>

            <!-- 侧边菜单 -->
			{empty name="$system.menu_mode"}
				{include file="/index/menu_classical" /}
			{else/}
				{if ($system.menu_mode == 'expand') }
					{include file="/index/menu_expand" /}
				{else/}
					{include file="/index/menu_classical" /}
				{/if}
			{/empty}
            <!-- 页面标签 -->
            <div id="pageTabs" class="page-tabs">
                <div class="layui-icon gg-tabs-control layui-icon-prev" gg-event="tabRollLeft"></div>
                <div class="layui-icon gg-tabs-control layui-icon-next" gg-event="tabRollRight"></div>
                <div class="layui-icon gg-tabs-control layui-icon-down">
                    <ul class="layui-nav gg-tabs-select">
                        <li class="layui-nav-item">
                            <a href="javascript:;"></a>
                            <dl class="layui-nav-child layui-anim-fadein">
                                <dd gg-event="closeThisTabs"><a href="javascript:;">关闭当前</a></dd>
                                <dd gg-event="closeOtherTabs"><a href="javascript:;">关闭其它</a></dd>
                                <dd gg-event="closeAllTabs"><a href="javascript:;">关闭全部</a></dd>
                            </dl>
                        </li>
                    </ul>
                </div>
                <div class="layui-tab gg-admin-tab" lay-unauto lay-allowClose="true" lay-filter="gg-admin-tab">
                    <ul class="layui-tab-title" id="pageTabUl">
                        <li lay-id="0" lay-attr="view/home/index.html" class="layui-this"><i class="iconfont icon-xueshuguanli"></i></li>
                    </ul>
                </div>
            </div>

            <!-- 主体内容 -->
            <div class="layui-body" id="GouguAppBody">
                <div class="gg-tab-page layui-show" id="tabItem0" data-id="0">
                    <iframe id="0" data-frameid="0" title="勾股OA" name="myiframe" src="{:url('/home/index/main')}" frameborder="0" data-timestamp="0" align="left" width="100%" height="100%" scrolling="yes"></iframe>
                </div>
            </div>
            <!-- 辅助元素，用于移动设备下遮罩 -->
            <div class="gg-body-shade" gg-event="shade"></div>
			<!-- 新消息通知 -->
            <div class="notification" style="display:none;">
				<audio id="msgSound"><source src="{__STATIC__}/home/file/msg.mp3" type="audio/mpeg"></audio>
			</div>
        </div>
    </div>
</div>
<!-- /主体 -->
{/block}
<!-- 脚本 -->
{block name="script"}
<script>
	const msg_sound = {$system.msg_sound|default=1};
	const watermark = {$system.watermark|default=1};
	const watermarkTxt = '{$admin.name|default="勾股OA"} {:substr($admin.mobile, -4)}';
	const moduleInit = ['tool','admin'];
	function gouguInit() {
		let admin = layui.admin;
		let tabs = admin.getCookie('gougutab');
		if(tabs && tabs!=''){
			let tab_parse = JSON.parse(tabs);
			let tab_id = tab_parse.tab_id,tab_array = tab_parse.tab_array;
			if(tab_array.length>0){
				for(let a=0; a<tab_array.length;a++){
					admin.tabTem(tab_array[a].id, tab_array[a].url,tab_array[a].title);
				}
				if(tab_id>0){
					admin.tabChange(tab_id);
				}
			}
		}
		admin.loading();
		menuInit();
		if(watermark==1){
			createWatermark();
		}
		$('#GouguApp').on("click",'[gg-event="logout"]',function () {
			layer.confirm('确认注销登录吗?', { icon: 7, title: '警告' }, function (index) {
				//注销
				$.ajax({
					url: "/home/login/login_out",
					success: function (e) {
						layer.msg(e.msg);
						if (e.code == 0) {
							setTimeout(function () {
								location.href = "{:url('home/login/index')}"
							}, 1000)
						}
					}
				})
				layer.close(index);
			});
		});
		layui.dropdown.render({
			elem: '#theme',
			trigger: 'mousedown',
			align: 'center',
			data: [{
				title: '汉缆蓝',
				theme: 'hlblue'
			},{
				title: '经典黑',
				theme: 'black'
			},{
				title: '简约白',
				theme: 'white'
			},{
				title: '海军蓝',
				theme: 'blue'
			}],
			click: function(data, othis){
				$.ajax({
					url: "/home/index/set_theme",
					data:{'theme':data.theme},
					success: function (e) {
						layer.msg(e.msg);
						if (e.code == 0) {
							setTimeout(function () {
								parent.location.reload();
							}, 1000)
						}
					}
				})
			}
		});
		//轮循获取消息
		let msg_num = 0,msg_bool=false;
		const msgSound = document.getElementById("msgSound");
		$(document).ready(function(){
			$(document).one('click',function(){
				msg_bool = true;
				//console.log("页面被点击了");
			});
		});
		
		$("#GouguAppBody").find('.gg-tab-page.layui-show iframe').on("load", function() {
			var iframeDocument = $(this).contents();
			iframeDocument.one('click',function(){
				msg_bool = true;
				//console.log("子页面被点击了");
			});
		});	
		
		var getStatus = setInterval(function () {
			$.ajax({
				url: "/api/index/get_msg",
				type:'post',
				success:function(e){
					if(e.code==0 && e.data!==''){
						if(e.data>0){
							$('#msgNum').show().find('span').html(e.data);
							if(e.data!=msg_num && msg_bool == true && msg_sound==1){
								msgSound.play();
								msg_num = e.data;
							}
						}
						else{
							$('#msgNum').hide().find('span').html(0);
						}
					}else{
						layer.closeAll();
					}
				}
			})
		}, 10000);
	}

	function createWatermark(){
		var canvas = document.createElement('canvas');
		canvas.width = 300;
		canvas.height = 200;
		var ctx = canvas.getContext('2d');
		ctx.font = '14px Arial';
		ctx.fillStyle = '#dddddd';
		ctx.textAlign = 'left';
		ctx.textBaseline = 'top';
		ctx.rotate(15 * Math.PI / 180);
		ctx.fillText(watermarkTxt, 20, 50);
		ctx.fillText(watermarkTxt, 180, 120);
		var dataURL = canvas.toDataURL('image/png');
		let node = document.createElement("div");
		node.style.pointerEvents = "none";
		node.style.position = "fixed";
		node.style.width = "100%";
		node.style.height = "100%";
		node.style.top = "0";
		node.style.left = "0";
		node.style.opacity = "0.36";
		node.style.zIndex = "998";
		node.style.background = 'url("' + dataURL + '")  0 0 repeat';
		// 将创建的元素插入body中，作为body的子元素
		document.body.appendChild(node);
	}
</script>
{/block}
<!-- /脚本 -->